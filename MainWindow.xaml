<Window
    x:Class="KALD_Control.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:KALD_Control.ViewModels"
    xmlns:conv="using:KALD_Control.Converters"
    mc:Ignorable="d">

    <Grid Background="{ThemeResource LayerFillColorDefaultBrush}" x:Name="RootGrid">
        <Grid.Resources>
            <conv:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
            <conv:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
            <conv:BoolToBrushConverter x:Key="BoolToBrushConverter"/>
            <conv:FrequencyConverter x:Key="FrequencyConverter"/>
            <conv:InterlockStatusToBrushConverter x:Key="InterlockStatusToBrushConverter"/>

            <SolidColorBrush x:Key="PrimaryAccentBrush" Color="#0078D4"/>
            <SolidColorBrush x:Key="SuccessBrush" Color="#107C10"/>
            <SolidColorBrush x:Key="WarningBrush" Color="#FF8C00"/>
            <SolidColorBrush x:Key="DangerBrush" Color="#D13438"/>
            <SolidColorBrush x:Key="SurfaceElevation1" Color="#F3F2F1"/>
            <SolidColorBrush x:Key="SurfaceElevation2" Color="#FAFAFA"/>
            <SolidColorBrush x:Key="BorderSubtle" Color="#E1DFDD"/>

            <Style x:Key="SectionHeaderStyle" TargetType="TextBlock">
                <Setter Property="FontSize" Value="18"/>
                <Setter Property="FontWeight" Value="SemiBold"/>
                <Setter Property="Foreground" Value="{ThemeResource TextFillColorPrimaryBrush}"/>
                <Setter Property="Margin" Value="0,0,0,12"/>
            </Style>

            <Style x:Key="SubheaderStyle" TargetType="TextBlock">
                <Setter Property="FontSize" Value="14"/>
                <Setter Property="FontWeight" Value="SemiBold"/>
                <Setter Property="Foreground" Value="{ThemeResource TextFillColorSecondaryBrush}"/>
                <Setter Property="Margin" Value="0,0,0,6"/>
            </Style>

            <Style x:Key="MetricValueStyle" TargetType="TextBlock">
                <Setter Property="FontSize" Value="24"/>
                <Setter Property="FontWeight" Value="Light"/>
                <Setter Property="FontFamily" Value="Segoe UI Variable"/>
                <Setter Property="Foreground" Value="{ThemeResource TextFillColorPrimaryBrush}"/>
            </Style>

            <Style x:Key="MetricUnitStyle" TargetType="TextBlock">
                <Setter Property="FontSize" Value="12"/>
                <Setter Property="FontWeight" Value="Normal"/>
                <Setter Property="Foreground" Value="{ThemeResource TextFillColorSecondaryBrush}"/>
                <Setter Property="VerticalAlignment" Value="Bottom"/>
                <Setter Property="Margin" Value="4,0,0,4"/>
            </Style>

            <Style x:Key="ElevatedCardStyle" TargetType="Border">
                <Setter Property="Background" Value="{ThemeResource CardBackgroundFillColorDefaultBrush}"/>
                <Setter Property="BorderBrush" Value="{ThemeResource CardStrokeColorDefaultBrush}"/>
                <Setter Property="BorderThickness" Value="1"/>
                <Setter Property="CornerRadius" Value="8"/>
                <Setter Property="Padding" Value="16"/>
                <Setter Property="Margin" Value="0,0,0,10"/>
                <Setter Property="Shadow">
                    <Setter.Value>
                        <ThemeShadow/>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="MetricCardStyle" TargetType="Border" BasedOn="{StaticResource ElevatedCardStyle}">
                <Setter Property="Padding" Value="12"/>
                <Setter Property="MinHeight" Value="90"/>
                <Setter Property="Margin" Value="6"/>
            </Style>

            <Style x:Key="PrimaryButtonStyle" TargetType="Button">
                <Setter Property="Padding" Value="16,8"/>
                <Setter Property="MinWidth" Value="90"/>
                <Setter Property="CornerRadius" Value="6"/>
                <Setter Property="FontWeight" Value="SemiBold"/>
                <Setter Property="Background" Value="{StaticResource PrimaryAccentBrush}"/>
                <Setter Property="Foreground" Value="White"/>
            </Style>

            <Style x:Key="SecondaryButtonStyle" TargetType="Button">
                <Setter Property="Padding" Value="16,8"/>
                <Setter Property="MinWidth" Value="90"/>
                <Setter Property="CornerRadius" Value="6"/>
                <Setter Property="FontWeight" Value="SemiBold"/>
                <Setter Property="BorderThickness" Value="1"/>
                <Setter Property="BorderBrush" Value="{ThemeResource CardStrokeColorDefaultBrush}"/>
            </Style>

            <Style x:Key="DangerButtonStyle" TargetType="Button">
                <Setter Property="Background" Value="{StaticResource DangerBrush}"/>
                <Setter Property="Foreground" Value="White"/>
                <Setter Property="Padding" Value="16,8"/>
                <Setter Property="MinWidth" Value="90"/>
                <Setter Property="CornerRadius" Value="6"/>
                <Setter Property="FontWeight" Value="SemiBold"/>
            </Style>

            <Style x:Key="StatusIndicatorStyle" TargetType="Border">
                <Setter Property="Width" Value="12"/>
                <Setter Property="Height" Value="12"/>
                <Setter Property="CornerRadius" Value="6"/>
                <Setter Property="Margin" Value="6,0"/>
            </Style>

            <Style x:Key="CompactButtonStyle" TargetType="Button">
                <Setter Property="Padding" Value="10,6"/>
                <Setter Property="MinWidth" Value="70"/>
                <Setter Property="CornerRadius" Value="4"/>
                <Setter Property="FontWeight" Value="SemiBold"/>
                <Setter Property="FontSize" Value="12"/>
            </Style>

            <!-- ADD TOGGLEBUTTON STYLE HERE -->
            <Style x:Key="CompactToggleButtonStyle" TargetType="ToggleButton">
                <Setter Property="Padding" Value="10,6"/>
                <Setter Property="MinWidth" Value="70"/>
                <Setter Property="CornerRadius" Value="4"/>
                <Setter Property="FontWeight" Value="SemiBold"/>
                <Setter Property="FontSize" Value="12"/>
                <Setter Property="BorderThickness" Value="1"/>
                <Setter Property="BorderBrush" Value="{ThemeResource CardStrokeColorDefaultBrush}"/>
                <Setter Property="Background" Value="{ThemeResource CardBackgroundFillColorSecondaryBrush}"/>
                <Setter Property="Foreground" Value="{ThemeResource TextFillColorPrimaryBrush}"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="ToggleButton">
                            <Grid x:Name="RootGrid" Background="{TemplateBinding Background}">
                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroup x:Name="CommonStates">
                                        <VisualState x:Name="Normal"/>
                                        <VisualState x:Name="PointerOver">
                                            <Storyboard>
                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="RootGrid" Storyboard.TargetProperty="Background">
                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource CardBackgroundFillColorDefaultBrush}"/>
                                                </ObjectAnimationUsingKeyFrames>
                                            </Storyboard>
                                        </VisualState>
                                        <VisualState x:Name="Pressed">
                                            <Storyboard>
                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="RootGrid" Storyboard.TargetProperty="Background">
                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="{ThemeResource CardBackgroundFillColorTertiaryBrush}"/>
                                                </ObjectAnimationUsingKeyFrames>
                                            </Storyboard>
                                        </VisualState>
                                        <VisualState x:Name="Checked">
                                            <Storyboard>
                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="RootGrid" Storyboard.TargetProperty="Background">
                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="{StaticResource PrimaryAccentBrush}"/>
                                                </ObjectAnimationUsingKeyFrames>
                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="Foreground">
                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="White"/>
                                                </ObjectAnimationUsingKeyFrames>
                                            </Storyboard>
                                        </VisualState>
                                        <VisualState x:Name="CheckedPointerOver">
                                            <Storyboard>
                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="RootGrid" Storyboard.TargetProperty="Background">
                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="{StaticResource PrimaryAccentBrush}"/>
                                                </ObjectAnimationUsingKeyFrames>
                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="Foreground">
                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="White"/>
                                                </ObjectAnimationUsingKeyFrames>
                                            </Storyboard>
                                        </VisualState>
                                        <VisualState x:Name="CheckedPressed">
                                            <Storyboard>
                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="RootGrid" Storyboard.TargetProperty="Background">
                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="{StaticResource PrimaryAccentBrush}"/>
                                                </ObjectAnimationUsingKeyFrames>
                                                <ObjectAnimationUsingKeyFrames Storyboard.TargetName="ContentPresenter" Storyboard.TargetProperty="Foreground">
                                                    <DiscreteObjectKeyFrame KeyTime="0" Value="White"/>
                                                </ObjectAnimationUsingKeyFrames>
                                            </Storyboard>
                                        </VisualState>
                                    </VisualStateGroup>
                                </VisualStateManager.VisualStateGroups>
                                <ContentPresenter x:Name="ContentPresenter"
                                      Content="{TemplateBinding Content}"
                                      ContentTemplate="{TemplateBinding ContentTemplate}"
                                      HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                      VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                      Margin="{TemplateBinding Padding}"/>
                            </Grid>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="InterlockIndicatorStyle" TargetType="Border">
                <Setter Property="Width" Value="10"/>
                <Setter Property="Height" Value="10"/>
                <Setter Property="CornerRadius" Value="5"/>
                <Setter Property="Margin" Value="2"/>
            </Style>
        </Grid.Resources>

        <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
            <StackPanel Margin="16">
                <!-- Connection & Status Bar -->
                <Border Style="{StaticResource ElevatedCardStyle}" Margin="0,0,0,12">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Status Indicator -->
                        <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,12,0">
                            <Border Style="{StaticResource StatusIndicatorStyle}"
                                    Background="{Binding IsConnected, Converter={StaticResource BoolToBrushConverter}, Mode=OneWay}"/>
                            <TextBlock Text="{Binding ConnectionStatus, Mode=OneWay}" 
                                       VerticalAlignment="Center" FontWeight="SemiBold"/>
                        </StackPanel>

                        <!-- Connection Controls -->
                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
                            <ComboBox Width="140" Header="Serial Port" 
                                      PlaceholderText="Select Port"
                                      ItemsSource="{Binding AvailablePorts, Mode=OneWay}"
                                      SelectedItem="{Binding SelectedPort, Mode=TwoWay}"/>

                            <ComboBox Width="100" Header="Baud Rate"
                                      ItemsSource="{Binding AvailableBaudRates, Mode=OneWay}"
                                      SelectedItem="{Binding SelectedBaudRate, Mode=TwoWay}"/>

                            <Button Content="Refresh" ToolTipService.ToolTip="Refresh Ports"
                                    Command="{Binding RefreshPortsCommand, Mode=OneWay}"
                                    Style="{StaticResource CompactButtonStyle}"/>
                        </StackPanel>

                        <!-- Connect/Disconnect Buttons -->
                        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                            <Button Content="Connect" 
                                    Style="{StaticResource PrimaryButtonStyle}"
                                    Command="{Binding ConnectCommand, Mode=OneWay}" 
                                    Visibility="{Binding IsConnected, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>

                            <Button Content="Disconnect"
                                    Style="{StaticResource SecondaryButtonStyle}"
                                    Command="{Binding DisconnectCommand, Mode=OneWay}" 
                                    Visibility="{Binding IsConnected, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Metrics Dashboard -->
                <Grid Margin="0,0,0,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Set Voltage Card -->
                    <Border Grid.Column="0" Style="{StaticResource MetricCardStyle}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Text="SET VOLTAGE" Style="{StaticResource SubheaderStyle}" HorizontalAlignment="Center"/>
                            <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                                <TextBlock Text="{Binding VoltageSetpoint, Mode=OneWay}" Style="{StaticResource MetricValueStyle}"/>
                                <TextBlock Text="V" Style="{StaticResource MetricUnitStyle}"/>
                            </StackPanel>
                            <ProgressBar Grid.Row="2" Value="{Binding VoltageSetpoint}" Maximum="1500" Height="4" 
                                         Foreground="{StaticResource PrimaryAccentBrush}"/>
                        </Grid>
                    </Border>

                    <!-- Actual Voltage Card -->
                    <Border Grid.Column="1" Style="{StaticResource MetricCardStyle}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Text="ACTUAL VOLTAGE" Style="{StaticResource SubheaderStyle}" HorizontalAlignment="Center"/>
                            <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                                <TextBlock Text="{Binding DeviceData.ActualVoltage, Mode=OneWay}" Style="{StaticResource MetricValueStyle}"/>
                                <TextBlock Text="V" Style="{StaticResource MetricUnitStyle}"/>
                            </StackPanel>
                            <ProgressBar Grid.Row="2" Value="{Binding DeviceData.ActualVoltage}" Maximum="1500" Height="4" 
                                         Foreground="{StaticResource SuccessBrush}"/>
                        </Grid>
                    </Border>

                    <!-- Energy Card -->
                    <Border Grid.Column="2" Style="{StaticResource MetricCardStyle}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Text="ENERGY" Style="{StaticResource SubheaderStyle}" HorizontalAlignment="Center"/>
                            <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                                <TextBlock Text="{Binding DeviceData.Energy, Mode=OneWay}" 
                                           Style="{StaticResource MetricValueStyle}"/>
                                <TextBlock Text="J" Style="{StaticResource MetricUnitStyle}"/>
                            </StackPanel>
                            <ProgressBar Grid.Row="2" Value="{Binding DeviceData.Energy}" Maximum="1000" Height="4" 
                                         Foreground="{StaticResource WarningBrush}"/>
                        </Grid>
                    </Border>

                    <!-- Shot Count Card -->
                    <Border Grid.Column="3" Style="{StaticResource MetricCardStyle}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Text="SHOTS FIRED" Style="{StaticResource SubheaderStyle}" HorizontalAlignment="Center"/>
                            <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                                <TextBlock Text="{Binding DeviceData.ShotCount, Mode=OneWay}" Style="{StaticResource MetricValueStyle}"/>
                            </StackPanel>
                            <ProgressBar Grid.Row="2" Value="{Binding DeviceData.ShotCount}" Maximum="{Binding TotalShots}" Height="4" 
                                         Foreground="{StaticResource PrimaryAccentBrush}"/>
                        </Grid>
                    </Border>

                    <!-- System State Card -->
                    <Border Grid.Column="4" Style="{StaticResource MetricCardStyle}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Text="SYSTEM STATE" Style="{StaticResource SubheaderStyle}" HorizontalAlignment="Center"/>
                            <TextBlock Grid.Row="1" Text="{Binding DeviceData.SystemState, Mode=OneWay}" 
                                       FontSize="16" FontWeight="SemiBold"
                                       HorizontalAlignment="Center" VerticalAlignment="Center"
                                       Foreground="{StaticResource PrimaryAccentBrush}"/>
                        </Grid>
                    </Border>
                </Grid>

                <!-- Configuration and Control Section -->
                <Grid Margin="0,0,0,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Laser Configuration Card -->
                    <Border Grid.Column="0" Grid.Row="0" Style="{StaticResource ElevatedCardStyle}" Margin="0,0,8,8">
                        <StackPanel>
                            <TextBlock Text="Laser Configuration" Style="{StaticResource SectionHeaderStyle}"/>

                            <StackPanel Orientation="Vertical" Spacing="12">
                                <!-- Voltage Control -->
                                <StackPanel>
                                    <TextBlock Text="Voltage (V)" Style="{StaticResource SubheaderStyle}"/>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <NumberBox Value="{Binding VoltageSetpoint, Mode=TwoWay}" 
                                                   Minimum="0" Maximum="1500" 
                                                   SpinButtonPlacementMode="Inline" Margin="0,0,8,0"/>
                                        <Button Grid.Column="1" Content="Apply" 
                                                Command="{Binding ApplySettingsCommand, Mode=OneWay}"
                                                Style="{StaticResource CompactButtonStyle}"/>
                                    </Grid>
                                </StackPanel>

                                <!-- Frequency Control -->
                                <StackPanel>
                                    <TextBlock Text="Frequency (Hz)" Style="{StaticResource SubheaderStyle}"/>
                                    <NumberBox Value="{Binding FrequencySetpoint, Mode=TwoWay}" 
                                               Minimum="0.1" Maximum="2000" 
                                               SpinButtonPlacementMode="Inline"/>
                                </StackPanel>

                                <!-- Pulse Width Control -->
                                <StackPanel>
                                    <TextBlock Text="Pulse Width (μs)" Style="{StaticResource SubheaderStyle}"/>
                                    <NumberBox Value="{Binding PulseWidth, Mode=TwoWay}" 
                                               Minimum="25" Maximum="25000" 
                                               SpinButtonPlacementMode="Inline"/>
                                </StackPanel>

                                <!-- Total Shots Control -->
                                <StackPanel>
                                    <TextBlock Text="Total Shots" Style="{StaticResource SubheaderStyle}"/>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <NumberBox Value="{Binding TotalShots, Mode=TwoWay}" 
                                                   Minimum="1" Maximum="1000000" 
                                                   SpinButtonPlacementMode="Inline" Margin="0,0,8,0"/>
                                        <Button Grid.Column="1" Content="Apply" 
                                                Command="{Binding ApplyPulseSettingsCommand, Mode=OneWay}"
                                                Style="{StaticResource CompactButtonStyle}"/>
                                    </Grid>
                                </StackPanel>

                                <!-- Delays -->
                                <StackPanel>
                                    <TextBlock Text="Delays (μs)" Style="{StaticResource SubheaderStyle}"/>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <NumberBox Grid.Column="0" Header="Delay 1" Value="{Binding Delay1, Mode=TwoWay}" 
                                                   Minimum="0" Maximum="10000" Margin="0,0,4,0"/>
                                        <NumberBox Grid.Column="1" Header="Delay 2" Value="{Binding Delay2, Mode=TwoWay}" 
                                                   Minimum="0" Maximum="10000" Margin="4,0,4,0"/>
                                        <Button Grid.Column="2" Content="Apply" 
                                                Command="{Binding SendLaserDelaysCommand, Mode=OneWay}"
                                                Style="{StaticResource CompactButtonStyle}" VerticalAlignment="Bottom"/>
                                    </Grid>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Mode Configuration Card -->
                    <Border Grid.Column="1" Grid.Row="0" Style="{StaticResource ElevatedCardStyle}" Margin="8,8,8,8">
                        <StackPanel>
                            <TextBlock Text="Mode Configuration" Style="{StaticResource SectionHeaderStyle}"/>

                            <StackPanel Orientation="Vertical" Spacing="12">
                                <!-- Trigger Mode -->
                                <StackPanel>
                                    <TextBlock Text="Trigger Mode" Style="{StaticResource SubheaderStyle}"/>
                                    <ComboBox ItemsSource="{Binding TriggerModes, Mode=OneWay}"
                                              SelectedItem="{Binding SelectedTriggerMode, Mode=TwoWay}"/>
                                </StackPanel>

                                <!-- Shot Mode -->
                                <StackPanel>
                                    <TextBlock Text="Shot Mode" Style="{StaticResource SubheaderStyle}"/>
                                    <ComboBox ItemsSource="{Binding ShotModes, Mode=OneWay}"
                                              SelectedItem="{Binding SelectedShotMode, Mode=TwoWay}"/>
                                </StackPanel>

                                <!-- Shutter Control -->
                                <StackPanel>
                                    <TextBlock Text="Shutter Control" Style="{StaticResource SubheaderStyle}"/>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <ComboBox Grid.Column="0" 
                                                  ItemsSource="{Binding ShutterModes, Mode=OneWay}"
                                                  SelectedItem="{Binding SelectedShutterMode, Mode=TwoWay}"
                                                  Margin="0,0,4,0"/>
                                        <ComboBox Grid.Column="1" 
                                                  ItemsSource="{Binding ShutterStates, Mode=OneWay}"
                                                  SelectedItem="{Binding SelectedShutterState, Mode=TwoWay}"
                                                  Margin="4,0,4,0"/>
                                        <Button Grid.Column="2" Content="Apply" 
                                                Command="{Binding ApplyShutterSettingsCommand, Mode=OneWay}"
                                                Style="{StaticResource CompactButtonStyle}"/>
                                    </Grid>
                                </StackPanel>

                                <!-- Soft Start -->
                                <StackPanel>
                                    <TextBlock Text="Soft Start" Style="{StaticResource SubheaderStyle}"/>
                                    <CheckBox Content="Enable Soft Start" IsChecked="{Binding SoftStartEnabled, Mode=TwoWay}"/>
                                    <NumberBox Header="Idle Setpoint (V)" Value="{Binding IdleSetpoint, Mode=TwoWay}" 
                                               Minimum="0" Maximum="1000" SpinButtonPlacementMode="Inline"/>
                                    <NumberBox Header="Ramp Count" Value="{Binding RampCount, Mode=TwoWay}" 
                                               Minimum="1" Maximum="10000" SpinButtonPlacementMode="Inline"/>
                                    <Button Content="Apply SoftStart" Command="{Binding ApplySoftStartCommand, Mode=OneWay}"
                                            Style="{StaticResource CompactButtonStyle}" Margin="0,8,0,0"/>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- System Log Panel -->
                    <Border Grid.Column="2" Grid.Row="0" Style="{StaticResource ElevatedCardStyle}" Margin="8,0,0,8">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,12">
                                <TextBlock Text="System Log" Style="{StaticResource SectionHeaderStyle}"/>
                                <Button Content="Clear" 
                                        Click="ClearLog_Click"
                                        Style="{StaticResource CompactButtonStyle}" 
                                        Margin="12,0,0,0"/>
                            </StackPanel>

                            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" 
                                          HorizontalScrollBarVisibility="Auto"
                                          Background="Transparent"
                                          CornerRadius="4" Padding="10">
                                <TextBox Text="{Binding LogText, Mode=OneWay}"
                                         TextWrapping="Wrap"
                                         AcceptsReturn="True"
                                         IsReadOnly="True"
                                         BorderThickness="0"
                                         Background="Transparent"
                                         FontFamily="Consolas"
                                         FontSize="12"
                                         Foreground="{ThemeResource TextFillColorPrimaryBrush}"/>
                            </ScrollViewer>
                        </Grid>
                    </Border>

                    <!-- Control Buttons Card -->
                    <Border Grid.Column="0" Grid.Row="1" Style="{StaticResource ElevatedCardStyle}" Margin="0,0,8,0">
                        <StackPanel>
                            <TextBlock Text="Laser Control" Style="{StaticResource SectionHeaderStyle}" HorizontalAlignment="Center"/>

                            <StackPanel Orientation="Horizontal" Spacing="12" HorizontalAlignment="Center" Margin="0,12,0,0">
                                <Button Content="ARM" 
                                        Command="{Binding ArmCommand, Mode=OneWay}"
                                        Style="{StaticResource PrimaryButtonStyle}"
                                        MinWidth="100"/>
                                <Button Content="DISARM" 
                                        Command="{Binding DisarmCommand, Mode=OneWay}"
                                        Style="{StaticResource SecondaryButtonStyle}"
                                        MinWidth="100"/>
                                <Button Content="FIRE" 
                                        Command="{Binding FireCommand, Mode=OneWay}"
                                        Style="{StaticResource DangerButtonStyle}"
                                        MinWidth="100"/>
                                <Button Content="STOP" 
                                        Command="{Binding StopCommand, Mode=OneWay}"
                                        Style="{StaticResource SecondaryButtonStyle}"
                                        MinWidth="100"/>
                            </StackPanel>

                            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center" Margin="0,12,0,0">
                                <Button Content="STATUS" Command="{Binding RequestStatusCommand, Mode=OneWay}"
                                        Style="{StaticResource SecondaryButtonStyle}" MinWidth="80"/>
                                <Button Content="WAVEFORM" Command="{Binding RequestWaveformCommand, Mode=OneWay}"
                                        Style="{StaticResource SecondaryButtonStyle}" MinWidth="80"/>
                                <ToggleButton Content="{Binding WaveformEnabled, Converter={StaticResource WaveformButtonTextConverter}}"
              Command="{Binding ToggleWaveformCommand, Mode=OneWay}"
              IsChecked="{Binding WaveformEnabled, Mode=TwoWay}"
              Style="{StaticResource CompactToggleButtonStyle}" MinWidth="80"/>
                                <Button Content="CANCEL CHARGE" Command="{Binding SendChargeCancelCommand, Mode=OneWay}"
                                        Style="{StaticResource DangerButtonStyle}" MinWidth="100"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Calibration Card -->
                    <Border Grid.Column="1" Grid.Row="1" Style="{StaticResource ElevatedCardStyle}" Margin="8,0,8,0">
                        <StackPanel>
                            <TextBlock Text="Calibration" Style="{StaticResource SectionHeaderStyle}" HorizontalAlignment="Center"/>

                            <StackPanel Orientation="Vertical" Spacing="12" Margin="0,12,0,0">
                                <NumberBox Header="Cap Volt Range" Value="{Binding CapVoltRange, Mode=TwoWay}" 
                                           Minimum="100" Maximum="5000" SpinButtonPlacementMode="Inline"/>
                                <Button Content="Apply Calibration" Command="{Binding ApplyCalibrationCommand, Mode=OneWay}"
                                        Style="{StaticResource CompactButtonStyle}"/>

                                <Button Content="System Reset" Command="{Binding SystemResetCommand, Mode=OneWay}"
                                        Style="{StaticResource DangerButtonStyle}" Margin="0,16,0,0"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Safety Interlocks Card -->
                    <Border Grid.Column="2" Grid.Row="1" Style="{StaticResource ElevatedCardStyle}" Margin="8,0,0,0">
                        <StackPanel>
                            <TextBlock Text="Safety Interlocks" Style="{StaticResource SectionHeaderStyle}" HorizontalAlignment="Center"/>

                            <Grid Margin="0,12,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <!-- Row 1 -->
                                <StackPanel Grid.Column="0" Grid.Row="0" HorizontalAlignment="Center" Spacing="4">
                                    <TextBlock Text="Power" HorizontalAlignment="Center" FontWeight="Medium" FontSize="11"/>
                                    <Border Style="{StaticResource InterlockIndicatorStyle}" 
                                            Background="{Binding InterlockStatus.PowerOK, Converter={StaticResource InterlockStatusToBrushConverter}}"
                                            HorizontalAlignment="Center"/>
                                </StackPanel>

                                <StackPanel Grid.Column="1" Grid.Row="0" HorizontalAlignment="Center" Spacing="4">
                                    <TextBlock Text="Temperature" HorizontalAlignment="Center" FontWeight="Medium" FontSize="11"/>
                                    <Border Style="{StaticResource InterlockIndicatorStyle}" 
                                            Background="{Binding InterlockStatus.TempOK, Converter={StaticResource InterlockStatusToBrushConverter}}"
                                            HorizontalAlignment="Center"/>
                                </StackPanel>

                                <StackPanel Grid.Column="2" Grid.Row="0" HorizontalAlignment="Center" Spacing="4">
                                    <TextBlock Text="Door" HorizontalAlignment="Center" FontWeight="Medium" FontSize="11"/>
                                    <Border Style="{StaticResource InterlockIndicatorStyle}" 
                                            Background="{Binding InterlockStatus.DoorOK, Converter={StaticResource InterlockStatusToBrushConverter}}"
                                            HorizontalAlignment="Center"/>
                                </StackPanel>

                                <StackPanel Grid.Column="3" Grid.Row="0" HorizontalAlignment="Center" Spacing="4">
                                    <TextBlock Text="Water" HorizontalAlignment="Center" FontWeight="Medium" FontSize="11"/>
                                    <Border Style="{StaticResource InterlockIndicatorStyle}" 
                                            Background="{Binding InterlockStatus.WaterOK, Converter={StaticResource InterlockStatusToBrushConverter}}"
                                            HorizontalAlignment="Center"/>
                                </StackPanel>

                                <!-- Row 2 -->
                                <StackPanel Grid.Column="0" Grid.Row="1" HorizontalAlignment="Center" Spacing="4">
                                    <TextBlock Text="Cover" HorizontalAlignment="Center" FontWeight="Medium" FontSize="11"/>
                                    <Border Style="{StaticResource InterlockIndicatorStyle}" 
                                            Background="{Binding InterlockStatus.CoverOK, Converter={StaticResource InterlockStatusToBrushConverter}}"
                                            HorizontalAlignment="Center"/>
                                </StackPanel>

                                <StackPanel Grid.Column="1" Grid.Row="1" HorizontalAlignment="Center" Spacing="4">
                                    <TextBlock Text="Discharge Temp" HorizontalAlignment="Center" FontWeight="Medium" FontSize="11"/>
                                    <Border Style="{StaticResource InterlockIndicatorStyle}" 
                                            Background="{Binding InterlockStatus.DischargeTempOK, Converter={StaticResource InterlockStatusToBrushConverter}}"
                                            HorizontalAlignment="Center"/>
                                </StackPanel>

                                <StackPanel Grid.Column="2" Grid.Row="1" HorizontalAlignment="Center" Spacing="4">
                                    <TextBlock Text="Over Voltage" HorizontalAlignment="Center" FontWeight="Medium" FontSize="11"/>
                                    <Border Style="{StaticResource InterlockIndicatorStyle}" 
                                            Background="{Binding InterlockStatus.OverVoltageOK, Converter={StaticResource InterlockStatusToBrushConverter}}"
                                            HorizontalAlignment="Center"/>
                                </StackPanel>

                                <StackPanel Grid.Column="3" Grid.Row="1" HorizontalAlignment="Center" Spacing="4">
                                    <TextBlock Text="Over Temp" HorizontalAlignment="Center" FontWeight="Medium" FontSize="11"/>
                                    <Border Style="{StaticResource InterlockIndicatorStyle}" 
                                            Background="{Binding InterlockStatus.OverTempOK, Converter={StaticResource InterlockStatusToBrushConverter}}"
                                            HorizontalAlignment="Center"/>
                                </StackPanel>
                            </Grid>

                            <Button Content="Reset Interlocks" Command="{Binding SendInterlockMaskCommand, Mode=OneWay}"
                                    Style="{StaticResource SecondaryButtonStyle}" Margin="0,12,0,0"/>
                        </StackPanel>
                    </Border>
                </Grid>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</Window>